<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Igor DejanoviÄ‡">
        
        <link rel="shortcut icon" href="../../img/favicon.ico">

	<title>CSV - Arpeggio</title>

        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">
        <link href="../../extra.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->
            <a class="navbar-brand" href="../..">Arpeggio</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li >
                        <a href="../..">Home</a>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">User Guide <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../getting_started/">Getting started</a>
</li>

                        
                            
<li >
    <a href="../../grammars/">Grammars</a>
</li>

                        
                            
<li >
    <a href="../../parse_trees/">Parse tree</a>
</li>

                        
                            
<li >
    <a href="../../handling_errors/">Handling errors</a>
</li>

                        
                            
<li >
    <a href="../../debugging/">Debugging</a>
</li>

                        
                            
<li >
    <a href="../../configuration/">Parser configuration</a>
</li>

                        
                            
<li >
    <a href="../../semantics/">Semantic analysis</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Tutorials <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li class="active">
    <a href="./">CSV</a>
</li>

                        
                            
<li >
    <a href="../bibtex/">BibTex</a>
</li>

                        
                            
<li >
    <a href="../calc/">Calc</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">About <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../about/discuss/">Discuss</a>
</li>

                        
                            
<li >
    <a href="../../about/contributing/">Contributing</a>
</li>

                        
                            
<li >
    <a href="../../about/license/">License</a>
</li>

                        
                        </ul>
                    </li>
                
                
                </ul>
            

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                
                    <li >
                        <a rel="next" href="../../semantics/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../bibtex/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
                
                
                    <li>
                        <a href="https://github.com/igordejanovic/Arpeggio">
                            
                                <i class="fa fa-github"></i>
                            
                            GitHub
                        </a>
                    </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#comma-separated-values-csv-parser-tutorial">Comma-Separated Values (CSV) parser tutorial</a></li>
        
            <li><a href="#the-grammar">The grammar</a></li>
        
            <li><a href="#the-parser">The parser</a></li>
        
            <li><a href="#parsing">Parsing</a></li>
        
            <li><a href="#defining-grammar-using-peg-notation">Defining grammar using PEG notation</a></li>
        
            <li><a href="#extract-data">Extract data</a></li>
        
    
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="comma-separated-values-csv-parser-tutorial">Comma-Separated Values (CSV) parser tutorial</h1>
<p>A tutorial for building parser for well known CSV format.</p>
<hr />
<p>In this tutorial we will see how to make a parser for a simple data interchange
format - <a href="">CSV</a> (Comma-Separated Values).
CSV is a textual format for tabular data interchange. It is described by
<a href="https://tools.ietf.org/html/rfc4180">RFC 4180</a>.</p>
<p><a href="https://en.wikipedia.org/wiki/Comma-separated_values">Here</a> is an example of
CSV file:</p>
<pre><code class="csv">Year,Make,Model,Length
1997,Ford,E350,2.34
2000,Mercury,Cougar,2.38
</code></pre>

<p>Although, there is <a href="https://docs.python.org/3/library/csv.html">csv module</a> in
the standard Python library this example has been made as the CSV is ubiquitous
and easy to understand so it it a good starter for learning Arpeggio.</p>
<h2 id="the-grammar">The grammar</h2>
<p>Let's start first by creating a python module called <code>csv.py</code>.</p>
<p>Now, let's define CSV grammar. </p>
<ul>
<li>
<p>CSV file consists of one or more records separated by a newline.</p>
<pre><code>def csvfile():    return OneOrMore([record, '\n']), EOF
</code></pre>
</li>
<li>
<p>Each record consists of fields separated with commas.</p>
<pre><code>def record():     return field, ZeroOrMore(",", field)
</code></pre>
</li>
<li>
<p>Each field may be quoted or not.</p>
<pre><code>def field():      return [quoted_field, field_content]
</code></pre>
</li>
<li>
<p>Field content is everything until newline or comma.</p>
<pre><code>def field_content():            return _(r'([^,\n])+')
</code></pre>
<p>We use regular expression to match everything that is not comma or
  newline.</p>
</li>
<li>
<p>Quoted field starts and ends with double quotes.</p>
<pre><code>def quoted_field():             return '"', field_content_quoted, '"'
</code></pre>
</li>
<li>
<p>Quoted field content is defined as </p>
<pre><code>def field_content_quoted():     return _(r'(("")|([^"]))+')
</code></pre>
<p>Quoted field content is defined with regular expression that will match
  everything until the closing double-quote. Double quote inside data must
  be escaped by doubling it (<code>""</code>).</p>
</li>
</ul>
<p>The whole content of the <code>csv.py</code> file until now should be:</p>
<pre><code>from arpeggio import *
from arpeggio import RegExMatch as _

# This is the CSV grammar
def record():                   return field, ZeroOrMore(",", field)
def field():                    return [quoted_field, field_content]
def quoted_field():             return '"', field_content_quoted, '"'
def field_content():            return _(r'([^,\n])+')
def field_content_quoted():     return _(r'(("")|([^"]))+')
def csvfile():                  return OneOrMore([record, '\n']), EOF
</code></pre>
<h2 id="the-parser">The parser</h2>
<p>Let's instantiate parser. In order to catch newlines in <code>csvfile</code> rule we must
tell Arpeggio not to treat newlines as whitespace, i.e. not to skip over them.
Thus, we will be able to handle them explicitly as we do in csvfile rule. To do
so we will use <code>ws</code> parameter in parser construction to redefine what is
considered as whitespace.  You can find more information
<a href="../../configuration/#white-space-handling">here</a>.</p>
<p>After the grammar in <code>csv.py</code> instantiate the parser:</p>
<pre><code>parser = ParserPython(csvfile, ws='\t ')
</code></pre>
<p>So, whitespace will be a tab char or a space. Newline will be treated as regular
character.  We give grammar root rule to the <code>ParserPython</code>. In this example it
is <code>csvfile</code> function.</p>
<p><code>parser</code> now refers to the parser object capable of parsing CSV inputs.</p>
<h2 id="parsing">Parsing</h2>
<p>Let's parse some CSV example string.</p>
<p>Create file <code>test_data.csv</code> with the following content:</p>
<pre><code>Unquoted test, "Quoted test", 23234, One Two Three, "343456.45"

Unquoted test 2, "Quoted test with ""inner"" quotes", 23234, One Two Three, "343456.45"
Unquoted test 3, "Quoted test 3", 23234, One Two Three, "343456.45"
</code></pre>
<p>In <code>csv.py</code> file write:</p>
<pre><code class="python">test_data = open('test_data.csv', 'r').read()
parse_tree = parser.parse(test_data)

</code></pre>

<p><code>test_data</code> is Python string containing test CSV data from the file. Calling
<code>parser.parse</code> on the data will produce the <a href="../../parse_trees/">parse tree</a>.</p>
<p>If you run <code>csv.py</code> module, and there are no syntax errors in the <code>test_data.csv</code>
file, <code>parse_tree</code> will be a reference to <a href="../../parse_trees/">parse tree</a> of
the test CSV data.</p>
<pre><code class="bash">$ python csv.py
</code></pre>

<p><strong>Congratulations!! You have successfuly parsed CSV file.</strong></p>
<p>This parse tree is <a href="../../debugging/#visualization">visualized</a> below
(Tip: The image is large. Right click on it and choose <code>View image</code> to see it in
a separate tab and to be able to use zooming):</p>
<p><img alt="CSV parse tree" src="../img/csvfile_parse_tree.dot.png" /></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To visualize grammar (aka parser model) and parse tree instantiate the
parser in debug mode.</p>
<pre><code>parser = ParserPython(csvfile, ws='\t ', debug=True)
</code></pre>
<p>Transform generated <code>dot</code> files to images.
See more <a href="../../debugging/#visualization">here</a></p>
</div>
<h2 id="defining-grammar-using-peg-notation">Defining grammar using PEG notation</h2>
<p>Now, let's try the same but using <a href="../../grammars/#grammars-written-in-peg-notations">textual PEG
notation</a> for the grammar
definition.</p>
<p>We shall repeat the process above but we shall encode rules in PEG.
We shall use clean PEG variant (<code>arpeggio.cleanpeg</code> module).</p>
<p>First, create textual file <code>csv.peg</code> to store the grammar.</p>
<ul>
<li>
<p>CSV file consists of one or more records separated by a newline.</p>
<pre><code>csvfile = (record / '\n')+ EOF
</code></pre>
</li>
<li>
<p>Each record consists of fields separated with commas.</p>
<pre><code>record = field ("," field)*
</code></pre>
</li>
<li>
<p>Each field may be quoted or not.</p>
<pre><code>field = quoted_field / field_content
</code></pre>
</li>
<li>
<p>Field content is everything until newline or comma.</p>
<pre><code>field_content = r'([^,\n])+'
</code></pre>
<p>We use regular expression to match everything that is not comma or
  newline.</p>
</li>
<li>
<p>Quoted field starts and ends with double quotes.</p>
<pre><code>quoted_field = '"' field_content_quoted '"'
</code></pre>
</li>
<li>
<p>Quoted field content is defined as </p>
<pre><code>field_content_quoted = r'(("")|([^"]))+'
</code></pre>
<p>Quoted field content is defined with regular expression that will match
  everything until the closing double-quote. Double quote inside data must
  be escaped by doubling it (<code>""</code>).</p>
</li>
</ul>
<p>The whole grammar (i.e. the contents of <code>csv.peg</code> file) is:</p>
<pre><code>  csvfile = (record / r'\n')+ EOF
  record = field ("," field)*
  field = quoted_field / field_content
  field_content = r'([^,\n])+'
  quoted_field = '"' field_content_quoted '"'
  field_content_quoted = r'(("")|([^"]))+'
</code></pre>
<p>Now, we shall create <code>csv_peg.py</code> file in order to instantiate our parser and
parse inputs.  This time we shall instantiate different parser class
(<code>ParserPEG</code>). The whole content of <code>csv_peg.py</code> should be:</p>
<pre><code class="python">from arpeggio.cleanpeg import ParserPEG

csv_grammar = open('csv.peg', 'r').read()
parser = ParserPEG(csv_grammar, 'csvfile', ws='\t ')
</code></pre>

<p>Here we load the grammar from <code>csv.peg</code> file and construct the parser using
<code>ParserPEG</code> class.</p>
<p>The rest of the code is the same as in <code>csv.py</code>. We load <code>test_data.csv</code> and
call <code>parser.parse</code> on it to produce parse tree.</p>
<p>To verify that everything works without errors execute <code>csv_peg.py</code> module.</p>
<pre><code class="bash">$ python csv_peg.py
</code></pre>

<p>If we put the parser in debug mode and generate parse tree image we can 
verify that we are getting the same parse tree regardless of the grammar
specification approach we use.</p>
<p>To put parser in debug mode add <code>debug=True</code> to the parser parameters list.</p>
<pre><code class="python">parser = ParserPEG(csv_grammar, 'csvfile', ws='\t ', debug=True)
</code></pre>

<h2 id="extract-data">Extract data</h2>
<p>Our main goal is to extract data from the <code>csv</code> file.</p>
<p>The parse tree we get as a result of parsing is not very useful on its own.
We need to transform it to some other data structure that we can use.</p>
<p>First lets define our target data structure we want to get.</p>
<p>Since <code>csv</code> consists of list of records where each record consists of fields
we shall construct python list of lists:</p>
<pre><code>  [
    [field1, field2, field3, ...],  # First row
    [field1, field2, field3,...],   # Second row
    [...],  # ...
    ...
  ]
</code></pre>
<p>To construct this list of list we may process parse tree by navigating its
nodes and building the required target data structure.
But, it is easier to use Arpeggio's support for <a href="../../semantics/">semantic analysis - Visitor
Pattern</a>.</p>
<p>Let's make a Visitor for CSV that will build our list of lists.</p>
<pre><code class="python">class CSVVisitor(PTNodeVisitor):
    def visit_record(self, node, children):
        # record is a list of fields. The children nodes are fields so just
        # transform it to python list.
        return list(children)

    def visit_csvfile(self, node, children):
        # We are not interested in empty lines so we will filter them.
        return [x for x in children if x!='\n']
</code></pre>

<p>and apply this visitor to the parse tree:</p>
<pre><code class="python">csv_content = visit_parse_tree(parse_tree, CSVVisitor())
</code></pre>

<p>Now if we pretty-print <code>csv_content</code> we can see that it is exactly what we wanted:</p>
<pre><code class="python">[   [   u'Unquoted test',
        u'Quoted test',
        u'23234',
        u'One Two Three',
        u'343456.45'],
    [   u'Unquoted test 2',
        u'Quoted test with &quot;&quot;inner&quot;&quot; quotes',
        u'23234',
        u'One Two Three',
        u'34312.7'],
    [   u'Unquoted test 3',
        u'Quoted test 3',
        u'23234',
        u'One Two Three',
        u'343486.12']]
</code></pre>

<p>But, there is more we can do. If we look at our data we can see that some fields
are of numeric type but they end up as strings in our target structure. Let's
convert them to Python floats or ints.  To do this conversion we will introduce
<code>visit_field</code> method in our <code>CSVVisitor</code> class.</p>
<pre><code class="python">class CSVVisitor(PTNodeVisitor):
  ...
  def visit_field(self, node, children):
      value = children[0]
      try:
          return float(value)
      except:
          pass
      try:
          return int(value)
      except:
          return value
  ...
</code></pre>

<p>If we pretty-print <code>csv_content</code> now we can see that numeric values are not strings
anymore but a proper Python types.</p>
<pre><code class="python">[   [u'Unquoted test', u'Quoted test', 23234.0, u'One Two Three', 343456.45],
    [   u'Unquoted test 2',
        u'Quoted test with &quot;&quot;inner&quot;&quot; quotes',
        23234.0,
        u'One Two Three',
        34312.7],
    [   u'Unquoted test 3',
        u'Quoted test 3',
        23234.0,
        u'One Two Three',
        343486.12]]
</code></pre>

<p>This example code can be found <a href="https://github.com/igordejanovic/Arpeggio/tree/master/examples/csv">here</a>.</p></div>
            
        </div>

        <footer class="col-md-12">
            <hr>
            
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>

        <script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script>
        <script>var base_url = '../..';</script>
        <script data-main="../../mkdocs/js/search.js" src="../../mkdocs/js/require.js"></script>
        <script src="../../js/base.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                    </div>
                    <div class="modal-body">
                        <p>
                            From here you can search these documents. Enter
                            your search terms below.
                        </p>
                        <form role="form">
                            <div class="form-group">
                                <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                            </div>
                        </form>
                        <div id="mkdocs-search-results"></div>
                    </div>
                    <div class="modal-footer">
                    </div>
                </div>
            </div>
        </div>

    </body>
</html>
