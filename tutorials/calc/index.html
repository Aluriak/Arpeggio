<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Igor DejanoviÄ‡">
        
        <link rel="shortcut icon" href="../../img/favicon.ico">

	<title>Calc - Arpeggio</title>

        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">
        <link href="../../extra.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->
            <a class="navbar-brand" href="../..">Arpeggio</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li >
                        <a href="../..">Home</a>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">User Guide <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../getting_started/">Getting started</a>
</li>

                        
                            
<li >
    <a href="../../grammars/">Grammars</a>
</li>

                        
                            
<li >
    <a href="../../parse_trees/">Parse tree</a>
</li>

                        
                            
<li >
    <a href="../../handling_errors/">Handling errors</a>
</li>

                        
                            
<li >
    <a href="../../debugging/">Debugging</a>
</li>

                        
                            
<li >
    <a href="../../configuration/">Parser configuration</a>
</li>

                        
                            
<li >
    <a href="../../semantics/">Semantic analysis</a>
</li>

                        
                            
<li >
    <a href="../../troubleshooting/">Troubleshooting</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Tutorials <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../csv/">CSV</a>
</li>

                        
                            
<li >
    <a href="../bibtex/">BibTex</a>
</li>

                        
                            
<li class="active">
    <a href="./">Calc</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">About <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../about/discuss/">Discuss</a>
</li>

                        
                            
<li >
    <a href="../../about/contributing/">Contributing</a>
</li>

                        
                            
<li >
    <a href="../../about/license/">License</a>
</li>

                        
                        </ul>
                    </li>
                
                
                </ul>
            

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                
                    <li >
                        <a rel="next" href="../bibtex/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../../about/discuss/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
                
                
                    <li>
                        <a href="https://github.com/igordejanovic/Arpeggio">
                            
                                <i class="fa fa-github"></i>
                            
                            GitHub
                        </a>
                    </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#calculator-tutorial">Calculator tutorial</a></li>
        
    
        <li class="main "><a href="#the-grammar">The grammar</a></li>
        
    
        <li class="main "><a href="#the-parser">The parser</a></li>
        
    
        <li class="main "><a href="#evaluating-parse-tree">Evaluating parse tree</a></li>
        
    
        <li class="main "><a href="#the-grammar-in-peg">The grammar in PEG</a></li>
        
    
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="calculator-tutorial">Calculator tutorial</h1>
<p>A tutorial for parsing and evaluation of arithmetic expressions.</p>
<hr />
<p>In this tutorial we will make a parser and evaluator for simple arithmetic
expression (numbers and operations - addition, subtraction, multiplication and
division).  The parser will be able to recognize and evaluate following
expressions:</p>
<pre><code>2+7-3.6
3/(3-1)+45*2.17+8
4*12+5-4*(2-8)
...
</code></pre>
<p>Evaluation will be done using <a href="../../semantics/">support for semantic analysis</a>.</p>
<p>Parsing infix expression has additional constraints related to operator
precedence. Arpeggio is recursive-descent parser, parsing the input from left to
right and doing a leftmost derivation. 
There is a simple technique that will enable proper evaluation in the context
of a different operator precedence.</p>
<p>Let's start with grammar definition.</p>
<h1 id="the-grammar">The grammar</h1>
<ul>
<li>Each <code>calc</code> file consists of one or more expressions.</li>
</ul>
<pre><code class="python">def calc():       return OneOrMore(expression), EOF
</code></pre>

<ul>
<li>Each expression is a sum or subtraction of terms.</li>
</ul>
<pre><code class="python">def expression(): return term, ZeroOrMore([&quot;+&quot;, &quot;-&quot;], term)
</code></pre>

<ul>
<li>Each term is a multiplication or division of factors.</li>
</ul>
<pre><code class="python">def term():       return factor, ZeroOrMore([&quot;*&quot;,&quot;/&quot;], factor)
</code></pre>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Notice that the order of precendence is from lower to upper.
The deeper is the grammar rule, the tighter is the bonding.</p>
</div>
<ul>
<li>Each factor is either a number or an expression inside brackets. The prefix
  sign is optional. This is a support for unary minus.</li>
</ul>
<pre><code class="python">def factor():     return Optional([&quot;+&quot;,&quot;-&quot;]), [number, (&quot;(&quot;, expression, &quot;)&quot;)]
</code></pre>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Notice indirect recursion here to <code>expression</code>. It is not left since the
opening bracket must be found.</p>
</div>
<ul>
<li>And finally we define <code>number</code> using regular expression as</li>
</ul>
<pre><code class="python">def number():     return _(r'\d*\.\d*|\d+')
</code></pre>

<h1 id="the-parser">The parser</h1>
<p>Using above grammar specified in <a href="../../grammars/#grammars-written-in-python">Python
notation</a> we instantiate the parser
using <code>ParserPython</code> class.</p>
<pre><code class="python">  parser = ParserPython(calc)
</code></pre>

<p>This parser is able to parse arithmetic expression like this</p>
<pre><code>-(4-1)*5+(2+4.67)+5.89/(.2+7)
</code></pre>

<p>and produce parse tree like this</p>
<p><img alt="calc parse tree" src="../../images/calc_parse_tree.dot.png" /></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>All tree images in this documentation are produced by running the parser
in <a href="../../debugging/">debug mode</a> and using <a href="../../debugging/#visualization">visualization
support</a>.</p>
</div>
<p>The parsing is done like this:</p>
<pre><code class="python">input_expr = &quot;-(4-1)*5+(2+4.67)+5.89/(.2+7)&quot;
parse_tree = parser.parse(input_expr)
</code></pre>

<p>By ordering operation in the grammar form lower to upper precendence we have
got the parse tree where the priority is retained. This will help us to easier
make an expression evaluation.</p>
<h1 id="evaluating-parse-tree">Evaluating parse tree</h1>
<p>To implement evaluation we shall use Arpeggio's support for <a href="../../semantics/">semantic
analysis</a> using visitor patter.</p>
<p>Visitor is an object with methods named <code>visit_&lt;rule&gt;</code> which gets called for 
each node of parse tree produced with the given rule. The processing of the 
tree nodes is done bottom-up.</p>
<pre><code class="python">class CalcVisitor(PTNodeVisitor):

    def visit_number(self, node, children):
        &quot;&quot;&quot;
        Converts node value to float.
        &quot;&quot;&quot;
        return float(node.value)

    ...

</code></pre>

<p>Visit method for the <code>number</code> rule will do the conversion of the matched text
to <code>float</code> type. This nodes will always be the terminal nodes and will be
evaluated first.</p>
<pre><code class="python">
    def visit_factor(self, node, children):
        &quot;&quot;&quot;
        Applies a sign to the expression or number.
        &quot;&quot;&quot;
        if len(children) == 1:
            return children[0]
        sign = -1 if children[0] == '-' else 1
        return sign * children[-1]

</code></pre>

<p>Factor will have an optional sign as the first child and whatever matches first
from the ordered choice of number and expression.
We take the last element. It must be the result of <code>number</code> or <code>expression</code>
evaluation and apply an optional sing on it.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Note that the constant string matches will be removed by the Arpeggio, thus
you will never get a constant string match in the children list.</p>
</div>
<pre><code class="python">
    def visit_term(self, node, children):
        &quot;&quot;&quot;
        Divides or multiplies factors.
        Factor nodes will be already evaluated.
        &quot;&quot;&quot;
        term = children[0]
        for i in range(2, len(children), 2):
            if children[i-1] == &quot;*&quot;:
                term *= children[i]
            else:
                term /= children[i]
        return term
</code></pre>

<p><code>term</code> consist of multiplication or divisions. Both operations are left
associative so we shall run from left to right. Each even element will be
evaluated <code>factor</code> while each odd element will be an operation to perform.
At the end we return the evaluated <code>term</code>.</p>
<pre><code class="python">    def visit_expression(self, node, children):
        &quot;&quot;&quot;
        Adds or substracts terms.
        Term nodes will be already evaluated.
        &quot;&quot;&quot;
        expr = 0
        start = 0
        # Check for unary + or - operator
        if text(children[0]) in &quot;+-&quot;:
            start = 1

        for i in range(start, len(children), 2):
            if i and children[i - 1] == &quot;-&quot;:
                expr -= children[i]
            else:
                expr += children[i]

        return expr
</code></pre>

<p>And finally the whole expression consists of additions and subtractions of
terms. A minor glitch here is a support for unary minus and plus sign.</p>
<p>Let's apply this visitor to our parse tree.</p>
<pre><code class="python">result = visit_parse_tree(parse_tree, CalcVisitor(debug=debug))
</code></pre>

<p>The result will be a <code>float</code> which represent the value of the given expression.</p>
<h1 id="the-grammar-in-peg">The grammar in PEG</h1>
<p>As a final note, the same grammar can be specified in <a href="../../grammars/#grammars-written-in-peg-notations">textual PEG
syntax</a>.</p>
<p>Either a clean PEG variant:</p>
<pre><code>number = r'\d*\.\d*|\d+'
factor = (&quot;+&quot; / &quot;-&quot;)?
          (number / &quot;(&quot; expression &quot;)&quot;)
term = factor (( &quot;*&quot; / &quot;/&quot;) factor)*
expression = term ((&quot;+&quot; / &quot;-&quot;) term)*
calc = expression+ EOF

</code></pre>

<p>or traditional PEG variant:</p>
<pre><code>number &lt;- r'\d*\.\d*|\d+';
factor &lt;- (&quot;+&quot; / &quot;-&quot;)?
          (number / &quot;(&quot; expression &quot;)&quot;);
term &lt;- factor (( &quot;*&quot; / &quot;/&quot;) factor)*;
expression &lt;- term ((&quot;+&quot; / &quot;-&quot;) term)*;
calc &lt;- expression+ EOF;
</code></pre>

<p>The grammar for textual PEG is parsed using Arpeggio itself and this shows the
flexibility of the Arpeggio parser.</p>
<p>The code for both parser can be found in the <a href="https://github.com/igordejanovic/Arpeggio/tree/master/examples/calc">Calc
example</a>.</p></div>
            
        </div>

        <footer class="col-md-12">
            <hr>
            
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>

        <script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script>
        <script>var base_url = '../..';</script>
        <script data-main="../../mkdocs/js/search.js" src="../../mkdocs/js/require.js"></script>
        <script src="../../js/base.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                    </div>
                    <div class="modal-body">
                        <p>
                            From here you can search these documents. Enter
                            your search terms below.
                        </p>
                        <form role="form">
                            <div class="form-group">
                                <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                            </div>
                        </form>
                        <div id="mkdocs-search-results"></div>
                    </div>
                    <div class="modal-footer">
                    </div>
                </div>
            </div>
        </div>

    </body>
</html>
